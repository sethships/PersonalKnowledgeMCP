# Personal Knowledge MCP - Environment Configuration Template (V1.0)
# Copy this file to .env and fill in your actual values

# ============================================================================
# Required: OpenAI API Key for Embedding Generation
# ============================================================================
# Get your API key from: https://platform.openai.com/api-keys
OPENAI_API_KEY=sk-your-api-key-here

# ============================================================================
# Optional: GitHub Personal Access Token (for private repositories)
# ============================================================================
# Create a PAT at: https://github.com/settings/tokens
# Required scopes: repo (for private repos)
GITHUB_PAT=ghp_your-token-here

# ============================================================================
# ChromaDB Connection (defaults work with docker-compose)
# ============================================================================
# ChromaDB host - defaults to localhost (container binds to 127.0.0.1 only for security)
CHROMADB_HOST=localhost
CHROMADB_PORT=8000

# ============================================================================
# ChromaDB Authentication Token (production security)
# ============================================================================
# Optional: Authentication token for ChromaDB server
# When set, both the server (docker-compose) and client will require this token
# Leave empty for unauthenticated access (development only)
#
# Generate a secure token with:
#   openssl rand -hex 32
#
# Token rotation: Generate new token, update here, restart docker-compose and MCP service
# CHROMADB_AUTH_TOKEN=your-secure-token-here

# ============================================================================
# PostgreSQL Configuration (Document Store)
# ============================================================================
# PostgreSQL database credentials for the document store
# Generate a secure password with: openssl rand -base64 32
#
# IMPORTANT: POSTGRES_PASSWORD is required - container will not start without it
POSTGRES_USER=pk_mcp
POSTGRES_PASSWORD=changeme-use-secure-password
POSTGRES_DB=personal_knowledge

# Connection settings (for future application use)
POSTGRES_HOST=localhost
POSTGRES_PORT=5432

# ============================================================================
# Neo4j Configuration (Graph Database)
# ============================================================================
# Neo4j graph database credentials for code dependency and relationship storage
# Generate a secure password with: openssl rand -base64 32
#
# IMPORTANT: NEO4J_PASSWORD is required - container will not start without it
NEO4J_USER=neo4j
NEO4J_PASSWORD=changeme-use-secure-password

# Connection settings (for future application use)
NEO4J_HOST=localhost
NEO4J_BOLT_PORT=7687
NEO4J_HTTP_PORT=7474

# ============================================================================
# ChromaDB Container Settings (docker-compose.yml overrides)
# ============================================================================
# These settings can override defaults in docker-compose.yml when set in .env
#
# CHROMADB_ALLOW_RESET: Override ALLOW_RESET in docker-compose.yml
# - Set to TRUE for development (enables reset endpoint)
# - Default is FALSE for production safety
# WARNING: Setting to TRUE enables the reset endpoint which deletes ALL data
CHROMADB_ALLOW_RESET=FALSE
#
# Reference: The following are hardcoded in docker-compose.yml (not overridable):
# - IS_PERSISTENT=TRUE (data persistence enabled)
# - ANONYMIZED_TELEMETRY=FALSE (telemetry disabled)

# ============================================================================
# Data Paths
# ============================================================================
# Directory where repositories will be cloned
REPO_CLONE_PATH=./data/repos

# Base data directory for all persistent data
DATA_PATH=./data

# ============================================================================
# Logging Configuration
# ============================================================================
# Log level: trace, debug, info, warn, error, fatal
LOG_LEVEL=info

# Log format: json or pretty (use pretty for development)
LOG_FORMAT=pretty

# ============================================================================
# Embedding Configuration
# ============================================================================
# Embedding provider selection (auto-detected if not set)
# Options: openai, transformers, ollama
# - openai: Requires OPENAI_API_KEY (high quality, API costs)
# - transformers: Local Transformers.js (no API costs, slower first run)
# - ollama: Local Ollama server (no API costs, requires Ollama running)
# Default: Auto-detects based on available credentials
# EMBEDDING_PROVIDER=openai

# OpenAI embedding model (used when EMBEDDING_PROVIDER=openai or auto-detected)
EMBEDDING_MODEL=text-embedding-3-small

# Embedding dimensions (1536 for text-embedding-3-small)
EMBEDDING_DIMENSIONS=1536

# ============================================================================
# Chunking Configuration
# ============================================================================
# Maximum tokens per chunk (affects embedding quality vs. granularity)
CHUNK_MAX_TOKENS=500

# Token overlap between consecutive chunks (for context continuity)
CHUNK_OVERLAP_TOKENS=50

# ============================================================================
# File Scanning Configuration
# ============================================================================
# Supported file extensions for indexing (comma-separated, no spaces)
SUPPORTED_EXTENSIONS=.js,.ts,.jsx,.tsx,.cs,.py,.java,.go,.rs,.cpp,.c,.h,.md,.txt,.rst,.json,.yaml,.yml,.toml

# Maximum file size to process (in bytes, 1MB = 1048576)
MAX_FILE_SIZE_BYTES=1048576

# ============================================================================
# Search Configuration
# ============================================================================
# Default number of search results
DEFAULT_SEARCH_LIMIT=10

# Maximum allowed search results
MAX_SEARCH_LIMIT=50

# Default similarity threshold (0.0 to 1.0)
DEFAULT_SIMILARITY_THRESHOLD=0.7

# Maximum length of content snippets in search results (characters)
SNIPPET_MAX_LENGTH=500

# ============================================================================
# Performance Configuration
# ============================================================================
# Maximum batch size for OpenAI embedding API calls (OpenAI limit is 100)
EMBEDDING_BATCH_SIZE=100

# Maximum retries for transient API failures
MAX_RETRIES=3

# Request timeout in milliseconds
REQUEST_TIMEOUT_MS=30000

# Initial delay before first retry (in milliseconds)
RETRY_INITIAL_DELAY_MS=1000

# Maximum delay between retries (caps exponential growth, in milliseconds)
RETRY_MAX_DELAY_MS=60000

# Backoff multiplier for exponential delay growth (e.g., 2 = delays double each retry)
RETRY_BACKOFF_MULTIPLIER=2

# ============================================================================
# Development/Debug Settings
# ============================================================================
# Enable debug mode (more verbose logging)
DEBUG=false

# Node environment (development, production, test)
NODE_ENV=development

# ============================================================================
# Update History Configuration
# ============================================================================
# Maximum number of update history entries to retain per repository
# Older entries are automatically rotated out when limit is exceeded
UPDATE_HISTORY_LIMIT=20

# ============================================================================
# HTTP Transport Configuration (Multi-Transport Support)
# ============================================================================
# Enable HTTP/SSE transport in addition to stdio (for Cursor, VS Code, etc.)
# Default: false (stdio-only for Claude Code compatibility)
HTTP_TRANSPORT_ENABLED=false

# HTTP server port (default 3001, 3000 typically used for dev servers)
HTTP_PORT=3001

# HTTP server host (default 127.0.0.1 for security)
# Use 0.0.0.0 for network access (not recommended without authentication)
HTTP_HOST=127.0.0.1

# Maximum concurrent SSE sessions (prevent resource exhaustion)
# Default: 100
HTTP_MAX_SSE_SESSIONS=100

# SSE session TTL in milliseconds (sessions idle beyond this are cleaned up)
# Default: 1800000 (30 minutes)
HTTP_SSE_SESSION_TTL_MS=1800000

# Stale session cleanup interval in milliseconds
# Default: 300000 (5 minutes)
HTTP_SSE_CLEANUP_INTERVAL_MS=300000

# ============================================================================
# Streamable HTTP Transport Configuration (MCP 2025-03-26 Specification)
# ============================================================================
# Modern MCP transport for Cursor, VS Code Continue extension, and other
# MCP clients that support the Streamable HTTP specification.
#
# Endpoint: POST/GET/DELETE /api/v1/mcp
# Session management via Mcp-Session-Id header

# Maximum concurrent Streamable HTTP sessions (prevent resource exhaustion)
# Default: 100
HTTP_MAX_STREAMABLE_SESSIONS=100

# Streamable HTTP session TTL in milliseconds (sessions idle beyond this are cleaned up)
# Default: 1800000 (30 minutes)
HTTP_STREAMABLE_SESSION_TTL_MS=1800000

# Stale Streamable HTTP session cleanup interval in milliseconds
# Default: 300000 (5 minutes)
HTTP_STREAMABLE_CLEANUP_INTERVAL_MS=300000

# ============================================================================
# Authentication Configuration (Bearer Token Authentication)
# ============================================================================
# Directory where tokens.json is stored (defaults to DATA_PATH if not set)
# AUTH_TOKEN_PATH=./data

# Enable token usage tracking (updates lastUsedAt, useCount on each validation)
# Default: true
AUTH_TRACK_TOKEN_USAGE=true

# ============================================================================
# Multi-Instance Configuration (Instance Isolation)
# ============================================================================
# The Personal Knowledge MCP supports multiple isolated instances for different
# security tiers: Private, Work, and Public. Each instance has its own:
# - ChromaDB database (separate ports and volumes)
# - Data directory
# - Optional authentication token
#
# Use Docker Compose profiles to run specific instances:
#   docker compose --profile all up -d         # All instances
#   docker compose --profile private up -d     # Private only
#   docker compose --profile work up -d        # Work only
#   docker compose --profile public up -d      # Public only
#   docker compose --profile default up -d     # Single instance (backwards compatible)

# Default instance for unauthenticated requests (stdio transport)
# Options: private, work, public
# Default: public (safest for local/LAN deployments)
DEFAULT_INSTANCE=public

# Require authentication for default instance access
# Set to true for internet-hosted deployments
# Set to false for local/LAN deployments where stdio is trusted
# Default: false
REQUIRE_AUTH_FOR_DEFAULT_INSTANCE=false

# ----------------------------------------------------------------------------
# Private Instance Configuration (Port 8000)
# For personal/sensitive knowledge base
# ----------------------------------------------------------------------------
INSTANCE_PRIVATE_CHROMADB_HOST=localhost
INSTANCE_PRIVATE_CHROMADB_PORT=8000
INSTANCE_PRIVATE_DATA_PATH=./data/private
INSTANCE_PRIVATE_ENABLED=true
# Optional: Private instance ChromaDB auth token (generate with: openssl rand -hex 32)
# INSTANCE_PRIVATE_CHROMADB_AUTH_TOKEN=

# Docker Compose env for private ChromaDB (matches INSTANCE_PRIVATE_CHROMADB_AUTH_TOKEN)
# CHROMADB_PRIVATE_AUTH_TOKEN=

# ----------------------------------------------------------------------------
# Work Instance Configuration (Port 8001)
# For work-related repositories
# ----------------------------------------------------------------------------
INSTANCE_WORK_CHROMADB_HOST=localhost
INSTANCE_WORK_CHROMADB_PORT=8001
INSTANCE_WORK_DATA_PATH=./data/work
INSTANCE_WORK_ENABLED=true
# Optional: Work instance ChromaDB auth token
# INSTANCE_WORK_CHROMADB_AUTH_TOKEN=

# Docker Compose env for work ChromaDB
# CHROMADB_WORK_AUTH_TOKEN=

# ----------------------------------------------------------------------------
# Public Instance Configuration (Port 8002)
# For public/OSS repositories
# ----------------------------------------------------------------------------
INSTANCE_PUBLIC_CHROMADB_HOST=localhost
INSTANCE_PUBLIC_CHROMADB_PORT=8002
INSTANCE_PUBLIC_DATA_PATH=./data/public
INSTANCE_PUBLIC_ENABLED=true
# Optional: Public instance ChromaDB auth token
# INSTANCE_PUBLIC_CHROMADB_AUTH_TOKEN=

# Docker Compose env for public ChromaDB
# CHROMADB_PUBLIC_AUTH_TOKEN=

# ============================================================================
# Rate Limiting Configuration (Abuse Protection)
# ============================================================================
# Rate limiting protects HTTP endpoints from abuse. Limits are applied
# per-token for authenticated requests and per-IP for unauthenticated.

# Enable or disable rate limiting (default: true)
RATE_LIMIT_ENABLED=true

# Read operation limits (GET, HEAD, OPTIONS requests)
# Default: 60 requests per minute, 1000 per hour
RATE_LIMIT_READ_PER_MINUTE=60
RATE_LIMIT_READ_PER_HOUR=1000

# Write operation limits (POST, PUT, PATCH, DELETE requests)
# Default: 30 requests per minute, 500 per hour
RATE_LIMIT_WRITE_PER_MINUTE=30
RATE_LIMIT_WRITE_PER_HOUR=500

# Allow admin tokens to bypass rate limits (default: true)
# Set to false to enforce limits on all tokens including admin
RATE_LIMIT_ADMIN_BYPASS=true

# ============================================================================
# CORS Configuration (Browser Client Support)
# ============================================================================
# Cross-Origin Resource Sharing (CORS) enables browser-based MCP clients
# to access the HTTP transport endpoints.

# Enable or disable CORS (default: true when HTTP_TRANSPORT_ENABLED)
CORS_ENABLED=true

# Allowed origins for CORS requests (comma-separated, no spaces)
# Default: http://localhost:3000
# Examples:
#   Single origin: http://localhost:3000
#   Multiple origins: http://localhost:3000,http://localhost:5173,https://myapp.com
CORS_ORIGINS=http://localhost:3000

# Allow credentials (cookies, Authorization headers) in CORS requests
# Default: true (required for authenticated requests)
CORS_CREDENTIALS=true

# How long (in seconds) browsers can cache preflight results
# Default: 86400 (24 hours)
# CORS_MAX_AGE=86400

# ============================================================================
# OIDC Configuration (Enterprise SSO - Framework Ready)
# ============================================================================
# OpenID Connect authentication enables enterprise SSO alongside bearer tokens.
# When enabled, users can authenticate via their identity provider (IdP).
#
# Supports: Microsoft Entra ID, Okta, Auth0, Google Workspace, Keycloak, etc.

# Enable OIDC authentication (default: false)
# When true, all required OIDC settings below must be configured
OIDC_ENABLED=false

# OIDC Issuer URL (required if OIDC_ENABLED=true)
# This is the base URL of your identity provider
# Examples:
#   Microsoft Entra ID: https://login.microsoftonline.com/{tenant-id}/v2.0
#   Auth0: https://{your-domain}.auth0.com/
#   Okta: https://{your-domain}.okta.com
#   Google: https://accounts.google.com
# OIDC_ISSUER=https://your-tenant.auth0.com/

# OAuth2 Client ID (required if OIDC_ENABLED=true)
# Get this from your identity provider when registering your application
# OIDC_CLIENT_ID=your-client-id

# OAuth2 Client Secret (required if OIDC_ENABLED=true)
# Keep this secret! Never commit to version control.
# OIDC_CLIENT_SECRET=your-client-secret

# OIDC Redirect URI (required if OIDC_ENABLED=true)
# The callback URL where users are redirected after authentication
# Must be registered in your identity provider's allowed callback URLs
# Format: {scheme}://{host}:{port}/api/v1/oidc/callback
# OIDC_REDIRECT_URI=http://localhost:3001/api/v1/oidc/callback

# Default scopes for OIDC-authenticated users (comma-separated)
# Options: read, write, admin
# Default: read
# All OIDC users will receive these scopes
OIDC_DEFAULT_SCOPES=read,write

# Default instance access for OIDC users (comma-separated)
# Options: private, work, public
# Default: public
# All OIDC users will have access to these instances
OIDC_DEFAULT_INSTANCE_ACCESS=work

# OIDC session lifetime in seconds (default: 3600 = 1 hour)
# After this time, users must re-authenticate
OIDC_SESSION_TTL_SECONDS=3600

# Refresh tokens this many seconds before expiry (default: 300 = 5 minutes)
# Set to 0 to disable automatic token refresh
OIDC_REFRESH_BEFORE_EXPIRY_SECONDS=300

# OIDC session cookie security (optional)
# Controls the Secure flag on OIDC session cookies
# Options:
#   true  - Cookies only sent over HTTPS (recommended for production)
#   false - Cookies sent over HTTP and HTTPS (for local development without TLS)
#   (unset) - Auto-detect based on NODE_ENV (secure if production)
# Default: auto-detect (secure when NODE_ENV=production)
# OIDC_COOKIE_SECURE=true

# ============================================================================
# User-to-Instance Authorization Mapping (Enterprise Access Control - Framework Ready)
# ============================================================================
# Map OIDC users to instances and scopes based on claims (email, groups, roles).
# Rules are defined in {DATA_PATH}/user-mappings.json and support:
# - Exact email matches (admin@company.com)
# - Email wildcards (*@company.com)
# - Group membership (group:developers)
# - Role assignments (role:admin)
# - Default fallback (*)
#
# See docs/user-mapping-configuration.md for examples and full documentation.

# Enable user-to-instance mapping (default: true when OIDC_ENABLED)
# When false, all OIDC users get OIDC_DEFAULT_SCOPES and OIDC_DEFAULT_INSTANCE_ACCESS
USER_MAPPING_ENABLED=true

# Identity Provider type for claims extraction
# Options: azure-ad, auth0, generic
# - azure-ad: Microsoft Entra ID (handles groups, wids, roles, oid claims)
# - auth0: Auth0 (handles namespaced claims like https://myapp.com/groups)
# - generic: Standard OIDC (configurable claim names)
# Default: generic
OIDC_IDP_TYPE=generic

# Group claim name (used by generic extractor)
# Override if your IdP uses a different claim name for groups
# Default: groups
OIDC_GROUP_CLAIM_NAME=groups

# Role claim name (used by generic extractor)
# Override if your IdP uses a different claim name for roles
# Default: roles
OIDC_ROLE_CLAIM_NAME=roles

# Enable file watcher for live configuration updates (default: true)
# When true, changes to user-mappings.json take effect without restart
USER_MAPPING_FILE_WATCHER=true

# File watcher debounce delay in milliseconds (default: 500)
# Prevents rapid reloads during multi-step file edits
USER_MAPPING_DEBOUNCE_MS=500

# ============================================================================
# OIDC Security Notes
# ============================================================================
# SESSION FILE PERMISSIONS (SECURITY WARNING):
# OIDC sessions are stored in {DATA_PATH}/oidc-sessions.json and contain
# sensitive tokens (access tokens, refresh tokens). On Linux/macOS, file
# permissions are set to 0600 (owner read/write only).
#
# ** WINDOWS USERS: ** chmod is ineffective on Windows. Session files may be
# readable by other users on the system. For production deployments:
# - Use Linux/Unix systems where possible
# - On Windows, use NTFS ACLs via icacls to restrict access:
#   icacls data\oidc-sessions.json /inheritance:r /grant:r "%USERNAME%:F"
# - Consider using a database-backed session store for multi-user systems
#
# See docs/security/oidc-deployment.md for comprehensive security guidance.

# ============================================================================
# Audit Logging Configuration (Security Compliance)
# ============================================================================
# Audit logging records security-relevant events for compliance and forensics.
# Events include: authentication, token lifecycle, instance access, config changes.
#
# Log format: JSON lines with ISO 8601 timestamps, event types, and context.
# Sensitive data is protected: only first 8 chars of token hashes are logged.

# Enable or disable audit logging (default: true)
AUDIT_LOG_ENABLED=true

# Audit log file path (relative to project root or absolute path)
# Directory will be created if it doesn't exist
AUDIT_LOG_PATH=./data/audit/audit.log

# Maximum size per log file before rotation (in bytes)
# Default: 10MB (10485760 bytes)
# Minimum: 1024 bytes
AUDIT_LOG_MAX_FILE_SIZE=10485760

# Maximum number of rotated log files to keep
# Older files are deleted when limit is exceeded
# Default: 10
AUDIT_LOG_MAX_FILES=10

# Retention period in days (0 = disabled, files kept until maxFiles limit)
# Files older than this are automatically deleted during rotation
# Default: 90 days
AUDIT_LOG_RETENTION_DAYS=90
