name: Helm Chart Test

on:
  push:
    paths:
      - 'charts/**'
    branches:
      - main
  pull_request:
    paths:
      - 'charts/**'

jobs:
  lint:
    name: Lint Helm Chart
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Lint chart
        run: helm lint ./charts/personal-knowledge-mcp

  template:
    name: Template Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Template with default values
        run: helm template pk-mcp ./charts/personal-knowledge-mcp

      - name: Template with dev values
        run: helm template pk-mcp ./charts/personal-knowledge-mcp -f charts/personal-knowledge-mcp/examples/values-dev.yaml

      - name: Template with prod values
        run: helm template pk-mcp ./charts/personal-knowledge-mcp -f charts/personal-knowledge-mcp/examples/values-prod.yaml

      - name: Template with private instance values
        run: helm template pk-mcp ./charts/personal-knowledge-mcp -f charts/personal-knowledge-mcp/examples/values-private.yaml

      - name: Template with work instance values
        run: helm template pk-mcp ./charts/personal-knowledge-mcp -f charts/personal-knowledge-mcp/examples/values-work.yaml

      - name: Template with public instance values
        run: helm template pk-mcp ./charts/personal-knowledge-mcp -f charts/personal-knowledge-mcp/examples/values-public.yaml

  schema-validation:
    name: Schema Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Validate schema (if exists)
        run: |
          if [ -f "./charts/personal-knowledge-mcp/values.schema.json" ]; then
            helm template pk-mcp ./charts/personal-knowledge-mcp --validate
          else
            echo "No values.schema.json found, skipping schema validation"
          fi
