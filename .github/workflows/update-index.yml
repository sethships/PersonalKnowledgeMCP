name: Update Knowledge Index

on:
  push:
    branches: [main]
    paths-ignore:
      - "*.md"
      - "docs/**"
      - ".github/workflows/update-index.yml"
  workflow_dispatch: # Allow manual triggers

jobs:
  update-index:
    name: Update Semantic Search Index
    runs-on: ubuntu-latest
    # Only run after CI passes (uses same job name as ci.yml)
    needs: []

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for accurate diff

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.3

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Start ChromaDB
        run: docker compose up -d chromadb
        env:
          POSTGRES_PASSWORD: ci-dummy-not-used

      - name: Wait for ChromaDB to be ready
        run: |
          echo "Waiting for ChromaDB to initialize..."
          for i in {1..60}; do
            if curl -f http://localhost:8000/api/v2/heartbeat 2>/dev/null; then
              echo "✓ ChromaDB is ready (attempt $i)"
              exit 0
            fi
            echo "⏳ Waiting for ChromaDB... ($i/60) - 2s intervals"
            sleep 2
          done
          echo "❌ ChromaDB failed to start after 120 seconds"
          docker compose logs chromadb
          exit 1
        env:
          POSTGRES_PASSWORD: ci-dummy-not-used

      - name: Update Knowledge Index
        run: |
          echo "Triggering incremental index update for PersonalKnowledgeMCP..."
          bun run cli update PersonalKnowledgeMCP || {
            echo "::warning::Index update failed or repository not yet indexed"
            echo "If this is the first run, index the repository first with: bun run cli index"
            exit 0  # Don't fail the workflow on first run
          }
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CHROMADB_URL: http://localhost:8000
          DATA_PATH: ./data

      - name: Show Index Status
        run: bun run cli status || true
        env:
          CHROMADB_URL: http://localhost:8000
          DATA_PATH: ./data

      - name: Stop ChromaDB
        if: always()
        run: docker compose down
        env:
          POSTGRES_PASSWORD: ci-dummy-not-used
