name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-and-build:
    name: Test & Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          # Updated from 1.3.3 to 1.3.5 to fix test isolation issues with vi.mock()
          # Bun 1.3.5 has improved mock handling that prevents leakage between test files
          # Pinned for stability - Bun is rapidly evolving and unpinned 'latest' could break builds
          # Dependabot: This is intentionally pinned - please create PR for version updates
          bun-version: 1.3.5

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          # .NET 10 is required for Roslyn analyzer (C# language support)
          # This enables full C# parsing tests in CI
          dotnet-version: "10.0.x"

      - name: Build Roslyn Analyzer
        run: |
          cd tools/roslyn-analyzer
          dotnet build --configuration Release
          echo "✓ Roslyn analyzer built successfully"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run type checking
        run: bun run typecheck

      - name: Run linting
        run: bun run lint

      - name: Run format check
        run: bun run format:check

      - name: Start ChromaDB
        run: docker compose up -d chromadb
        env:
          # Required for docker-compose.yml parsing (services require passwords)
          # These are dummy values - postgres/neo4j aren't started in CI, but compose needs to parse the file
          POSTGRES_PASSWORD: ci-dummy-not-used
          NEO4J_PASSWORD: ci-dummy-not-used

      - name: Wait for ChromaDB to be ready
        run: |
          echo "Waiting for ChromaDB to initialize..."
          for i in {1..60}; do
            if curl -f http://localhost:8000/api/v2/heartbeat 2>/dev/null; then
              echo "✓ ChromaDB is ready (attempt $i)"
              exit 0
            fi
            echo "⏳ Waiting for ChromaDB... ($i/60) - 2s intervals"
            sleep 2
          done
          echo "❌ ChromaDB failed to start after 120 seconds"
          docker compose logs chromadb
          exit 1
        env:
          # Required for docker-compose.yml parsing (services require passwords)
          POSTGRES_PASSWORD: ci-dummy-not-used
          NEO4J_PASSWORD: ci-dummy-not-used

      - name: Run tests with coverage
        # Run main tests first (excluding isolated tests to prevent vi.mock leakage)
        run: bun test --coverage --coverage-reporter=lcov tests/example.test.ts tests/integration tests/mcp tests/services tests/unit tests/cli tests/helpers tests/fixtures

      - name: Run isolated tests
        # Run isolated tests separately to prevent vi.mock from leaking to other test files
        # These tests mock modules that would affect other tests if run together
        run: bun test tests/isolated

      - name: Build project
        run: bun run build

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          fail_ci_if_error: false
        continue-on-error: true

      - name: Stop ChromaDB
        if: always()
        run: docker compose down
        env:
          # Required for docker-compose.yml parsing (services require passwords)
          POSTGRES_PASSWORD: ci-dummy-not-used
          NEO4J_PASSWORD: ci-dummy-not-used

  # Optional job: ChromaDB Authentication Integration Tests
  # This job tests ChromaDB client behavior when authentication is enabled.
  # It runs in addition to the main test suite to verify auth functionality.
  test-chromadb-auth:
    name: ChromaDB Auth Tests
    runs-on: ubuntu-latest
    needs: test-and-build
    # Only run on main branch or PRs that touch auth-related files
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.5

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Start Auth-Enabled ChromaDB
        run: |
          docker compose -f docker-compose.yml -f docker-compose.test.yml --profile test-auth up -d
        env:
          # Test token for auth-enabled ChromaDB (used in CI only)
          CHROMADB_TEST_AUTH_TOKEN: ${{ secrets.CHROMADB_TEST_AUTH_TOKEN || 'ci-test-token-12345' }}
          # Required for docker-compose.yml parsing
          POSTGRES_PASSWORD: ci-dummy-not-used
          NEO4J_PASSWORD: ci-dummy-not-used

      - name: Wait for Auth-Enabled ChromaDB to be ready
        run: |
          echo "Waiting for auth-enabled ChromaDB to initialize..."
          for i in {1..45}; do
            if curl -f http://localhost:8100/api/v2/heartbeat 2>/dev/null; then
              echo "✓ Auth-enabled ChromaDB is ready (attempt $i)"
              exit 0
            fi
            echo "⏳ Waiting for auth-enabled ChromaDB... ($i/45) - 2s intervals"
            sleep 2
          done
          echo "❌ Auth-enabled ChromaDB failed to start after 90 seconds"
          docker compose -f docker-compose.yml -f docker-compose.test.yml --profile test-auth logs chromadb-test-auth
          exit 1
        env:
          CHROMADB_TEST_AUTH_TOKEN: ${{ secrets.CHROMADB_TEST_AUTH_TOKEN || 'ci-test-token-12345' }}
          POSTGRES_PASSWORD: ci-dummy-not-used
          NEO4J_PASSWORD: ci-dummy-not-used

      - name: Run ChromaDB Auth Integration Tests
        run: bun test tests/integration/storage/chroma-auth-integration.test.ts
        env:
          RUN_AUTH_INTEGRATION_TESTS: "true"
          CHROMADB_TEST_AUTH_TOKEN: ${{ secrets.CHROMADB_TEST_AUTH_TOKEN || 'ci-test-token-12345' }}
          CHROMADB_AUTH_TEST_HOST: localhost
          CHROMADB_AUTH_TEST_PORT: "8100"

      - name: Stop Auth-Enabled ChromaDB
        if: always()
        run: docker compose -f docker-compose.yml -f docker-compose.test.yml --profile test-auth down
        env:
          CHROMADB_TEST_AUTH_TOKEN: ${{ secrets.CHROMADB_TEST_AUTH_TOKEN || 'ci-test-token-12345' }}
          POSTGRES_PASSWORD: ci-dummy-not-used
          NEO4J_PASSWORD: ci-dummy-not-used
