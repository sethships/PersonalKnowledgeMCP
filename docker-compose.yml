# Personal Knowledge MCP - Docker Compose Configuration
# Multi-Instance Support with ChromaDB and FalkorDB (Production Hardened)
# MCP service runs on host (not containerized) due to stdio transport requirement
#
# Usage:
#   docker compose --profile default up -d     # Single instance (backwards compatible)
#   docker compose --profile private up -d     # Private instance only
#   docker compose --profile work up -d        # Work instance only
#   docker compose --profile public up -d      # Public instance only
#   docker compose --profile all up -d         # All instances
#
# NOTE: Resource limits (deploy.resources) require Docker Compose v2.
# Use 'docker compose' (v2) or 'docker-compose --compatibility' for limits to apply.

# Common ChromaDB configuration template (YAML anchor)
x-chromadb-common: &chromadb-common
  image: chromadb/chroma:0.6.3
  networks:
    - pk-mcp-network
  restart: unless-stopped
  deploy:
    resources:
      limits:
        cpus: "2"
        memory: 2G
      reservations:
        cpus: "0.5"
        memory: 512M
  healthcheck:
    test:
      [
        "CMD-SHELL",
        'python -c ''import urllib.request; urllib.request.urlopen("http://localhost:8000/api/v2/heartbeat")''',
      ]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 40s
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

services:
  # ============================================================================
  # ChromaDB - Default Single Instance (Backwards Compatible)
  # Use profile "default" for single-instance deployments
  # ============================================================================
  chromadb:
    <<: *chromadb-common
    container_name: pk-mcp-chromadb
    profiles:
      - default
    ports:
      - "127.0.0.1:8000:8000"
    volumes:
      - chromadb-data:/chroma/chroma
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
      - ALLOW_RESET=${CHROMADB_ALLOW_RESET:-FALSE}
      - CHROMA_SERVER_AUTHN_PROVIDER=${CHROMADB_AUTH_TOKEN:+chromadb.auth.token_authn.TokenAuthenticationServerProvider}
      - CHROMA_SERVER_AUTHN_CREDENTIALS=${CHROMADB_AUTH_TOKEN:-}
      - CHROMA_AUTH_TOKEN_TRANSPORT_HEADER=Authorization

  # ============================================================================
  # ChromaDB - Private Instance (Port 8000)
  # For personal/sensitive knowledge base
  # ============================================================================
  chromadb-private:
    <<: *chromadb-common
    container_name: pk-mcp-chromadb-private
    profiles:
      - private
      - all
    ports:
      - "127.0.0.1:8000:8000"
    volumes:
      - chromadb-private-data:/chroma/chroma
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
      - ALLOW_RESET=${CHROMADB_ALLOW_RESET:-FALSE}
      - CHROMA_SERVER_AUTHN_PROVIDER=${CHROMADB_PRIVATE_AUTH_TOKEN:+chromadb.auth.token_authn.TokenAuthenticationServerProvider}
      - CHROMA_SERVER_AUTHN_CREDENTIALS=${CHROMADB_PRIVATE_AUTH_TOKEN:-}
      - CHROMA_AUTH_TOKEN_TRANSPORT_HEADER=Authorization

  # ============================================================================
  # ChromaDB - Work Instance (Port 8001)
  # For work-related repositories
  # ============================================================================
  chromadb-work:
    <<: *chromadb-common
    container_name: pk-mcp-chromadb-work
    profiles:
      - work
      - all
    ports:
      - "127.0.0.1:8001:8000"
    volumes:
      - chromadb-work-data:/chroma/chroma
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
      - ALLOW_RESET=${CHROMADB_ALLOW_RESET:-FALSE}
      - CHROMA_SERVER_AUTHN_PROVIDER=${CHROMADB_WORK_AUTH_TOKEN:+chromadb.auth.token_authn.TokenAuthenticationServerProvider}
      - CHROMA_SERVER_AUTHN_CREDENTIALS=${CHROMADB_WORK_AUTH_TOKEN:-}
      - CHROMA_AUTH_TOKEN_TRANSPORT_HEADER=Authorization

  # ============================================================================
  # ChromaDB - Public Instance (Port 8002)
  # For public/OSS repositories
  # ============================================================================
  chromadb-public:
    <<: *chromadb-common
    container_name: pk-mcp-chromadb-public
    profiles:
      - public
      - all
    ports:
      - "127.0.0.1:8002:8000"
    volumes:
      - chromadb-public-data:/chroma/chroma
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
      - ALLOW_RESET=${CHROMADB_ALLOW_RESET:-FALSE}
      - CHROMA_SERVER_AUTHN_PROVIDER=${CHROMADB_PUBLIC_AUTH_TOKEN:+chromadb.auth.token_authn.TokenAuthenticationServerProvider}
      - CHROMA_SERVER_AUTHN_CREDENTIALS=${CHROMADB_PUBLIC_AUTH_TOKEN:-}
      - CHROMA_AUTH_TOKEN_TRANSPORT_HEADER=Authorization

  # ============================================================================
  # Document Store (PostgreSQL) - Phase 4
  # ============================================================================
  postgres:
    image: postgres:17.2-alpine
    container_name: pk-mcp-postgres
    profiles:
      - default
      - all
    ports:
      - "127.0.0.1:5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d:ro
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-pk_mcp}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}
      - POSTGRES_DB=${POSTGRES_DB:-personal_knowledge}
    networks:
      - pk-mcp-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER:-pk_mcp} -d ${POSTGRES_DB:-personal_knowledge}",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # FalkorDB - Graph Database (Apache 2.0 licensed)
  # For code dependency and knowledge relationship storage
  # Uses Redis protocol on port 6380
  # ============================================================================
  falkordb:
    image: falkordb/falkordb:v4.4.1
    container_name: pk-mcp-falkordb
    profiles:
      - default
      - all
    ports:
      - "127.0.0.1:6380:6379"
    volumes:
      - falkordb-data:/data
    environment:
      - FALKORDB_PASSWORD=${FALKORDB_PASSWORD:-testpassword}
    networks:
      - pk-mcp-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a ${FALKORDB_PASSWORD:-testpassword} ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  pk-mcp-network:
    driver: bridge

volumes:
  # Default single-instance volume (backwards compatible)
  chromadb-data:
    driver: local
  # Multi-instance volumes
  chromadb-private-data:
    driver: local
  chromadb-work-data:
    driver: local
  chromadb-public-data:
    driver: local
  # PostgreSQL
  postgres-data:
    driver: local
  # FalkorDB
  falkordb-data:
    driver: local
