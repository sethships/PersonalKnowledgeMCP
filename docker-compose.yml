# Personal Knowledge MCP - Docker Compose Configuration (Phase 2)
# Phase 2: ChromaDB with production hardening
# MCP service runs on host (not containerized) due to stdio transport requirement
#
# NOTE: Resource limits (deploy.resources) require Docker Compose v2.
# Use 'docker compose' (v2) or 'docker-compose --compatibility' for limits to apply.

services:
  # ============================================================================
  # Vector Database (ChromaDB)
  # Phase 2 - Production Hardened
  # ============================================================================
  chromadb:
    image: chromadb/chroma:0.6.3
    container_name: pk-mcp-chromadb
    ports:
      - "127.0.0.1:8000:8000" # HTTP API - localhost only for security
    volumes:
      - chromadb-data:/chroma/chroma
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
      # ALLOW_RESET: FALSE for production safety, override with CHROMADB_ALLOW_RESET=TRUE for development
      - ALLOW_RESET=${CHROMADB_ALLOW_RESET:-FALSE}
      # Authentication: When CHROMADB_AUTH_TOKEN is set, require token authentication
      # Leave CHROMADB_AUTH_TOKEN unset/empty for unauthenticated access (development only)
      - CHROMA_SERVER_AUTHN_PROVIDER=${CHROMADB_AUTH_TOKEN:+chromadb.auth.token_authn.TokenAuthenticationServerProvider}
      - CHROMA_SERVER_AUTHN_CREDENTIALS=${CHROMADB_AUTH_TOKEN:-}
      - CHROMA_AUTH_TOKEN_TRANSPORT_HEADER=Authorization
    networks:
      - pk-mcp-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c ''import urllib.request; urllib.request.urlopen("http://localhost:8000/api/v2/heartbeat")''',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # Graph Database (Neo4j Community) - Phase 4
  # Disabled for Phase 1, uncomment for Phase 4
  # ============================================================================
  # neo4j:
  #   image: neo4j:5.25.1-community
  #   container_name: pk-mcp-neo4j
  #   ports:
  #     - "7474:7474"  # HTTP
  #     - "7687:7687"  # Bolt
  #   volumes:
  #     - neo4j-data:/data
  #     - neo4j-logs:/logs
  #   environment:
  #     - NEO4J_AUTH=${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-changeme}
  #     - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
  #     - NEO4J_server_memory_heap_initial__size=512m
  #     - NEO4J_server_memory_heap_max__size=2G
  #     - NEO4J_server_memory_pagecache_size=1G
  #   networks:
  #     - pk-mcp-network
  #   restart: unless-stopped

  # ============================================================================
  # Document Store (PostgreSQL) - Phase 2
  # Disabled for Phase 1, uncomment for Phase 2
  # ============================================================================
  # postgres:
  #   image: postgres:17.2-alpine
  #   container_name: pk-mcp-postgres
  #   ports:
  #     - "5432:5432"
  #   volumes:
  #     - postgres-data:/var/lib/postgresql/data
  #   environment:
  #     - POSTGRES_USER=${POSTGRES_USER:-pk_mcp_user}
  #     - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
  #     - POSTGRES_DB=${POSTGRES_DATABASE:-personal_knowledge}
  #   networks:
  #     - pk-mcp-network
  #   restart: unless-stopped

networks:
  pk-mcp-network:
    driver: bridge

volumes:
  chromadb-data:
    driver: local
  # neo4j-data:
  #   driver: local
  # neo4j-logs:
  #   driver: local
  # postgres-data:
  #   driver: local
