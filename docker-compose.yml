version: '3.8'

# Personal Knowledge MCP - Docker Compose Configuration
# This configuration supports local development and MVP deployment

services:
  # ============================================================================
  # MCP Service (Personal Knowledge MCP)
  # ============================================================================
  mcp-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: personal-knowledge-mcp
    ports:
      - "8080:8080"
      - "9090:9090"  # Metrics
    environment:
      - MCP_SERVICE_HOST=0.0.0.0
      - MCP_SERVICE_PORT=8080
      - INSTANCE_NAME=${INSTANCE_NAME:-private}
      - QDRANT_HOST=qdrant
      - NEO4J_URI=bolt://neo4j:7687
      - POSTGRES_HOST=postgres
    env_file:
      - .env
    volumes:
      - ./src:/app/src:ro
      - ./config:/app/config:ro
      - ./logs:/var/log/personal-knowledge-mcp
      - repo-clones:/tmp/cloned_repos
    depends_on:
      - qdrant
      - neo4j
      - postgres
    networks:
      - knowledge-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================================================
  # Vector Database (Qdrant)
  # ============================================================================
  qdrant:
    image: qdrant/qdrant:v1.12.1
    container_name: knowledge-qdrant
    ports:
      - "6333:6333"  # HTTP API
      - "6334:6334"  # gRPC
    volumes:
      - qdrant-storage:/qdrant/storage
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
    networks:
      - knowledge-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # Graph Database (Neo4j Community)
  # Phase 4 - Commented out for Phase 1
  # ============================================================================
  neo4j:
    image: neo4j:5.25.1-community
    container_name: knowledge-neo4j
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
    environment:
      - NEO4J_AUTH=${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-changeme}
      - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
      - NEO4J_server_memory_heap_initial__size=512m
      - NEO4J_server_memory_heap_max__size=2G
      - NEO4J_server_memory_pagecache_size=1G
    networks:
      - knowledge-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "neo4j", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================================
  # Document Store (PostgreSQL with JSON support)
  # Phase 2 - Commented out for Phase 1
  # ============================================================================
  postgres:
    image: postgres:17.2-alpine
    container_name: knowledge-postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-knowledge_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
      - POSTGRES_DB=${POSTGRES_DATABASE:-knowledge_store}
    networks:
      - knowledge-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-knowledge_user}"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # Optional: Prometheus for Metrics (Future)
  # ============================================================================
  # prometheus:
  #   image: prom/prometheus:latest
  #   container_name: knowledge-prometheus
  #   ports:
  #     - "9091:9090"
  #   volumes:
  #     - ./config/prometheus.yml:/etc/prometheus/prometheus.yml:ro
  #     - prometheus-data:/prometheus
  #   command:
  #     - '--config.file=/etc/prometheus/prometheus.yml'
  #     - '--storage.tsdb.path=/prometheus'
  #   networks:
  #     - knowledge-network
  #   restart: unless-stopped

networks:
  knowledge-network:
    driver: bridge

volumes:
  qdrant-storage:
    driver: local
  neo4j-data:
    driver: local
  neo4j-logs:
    driver: local
  postgres-data:
    driver: local
  repo-clones:
    driver: local
  # prometheus-data:
  #   driver: local
